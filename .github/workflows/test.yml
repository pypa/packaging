name: Test

on:
  pull_request:
    paths:
      - '.github/workflows/test.yml'
      - '**.py'
  push:
    paths:
      - '.github/workflows/test.yml'
      - '**.py'

jobs:
  test:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}-latest
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu, windows, macOS]
    steps:
    - uses: actions/checkout@v1

    # Install *all* Python versions that we want to test against!
    #
    # note 1: Python 3.4 is not available from actions/setup-python@v1.
    # note 2: PyPy3 + Windows is failing due to pip not being in the
    #         virtual environment created by nox.
    #         https://github.com/pypa/packaging/runs/424785871#step:7:9
    - name: Install PyPy2
      uses: actions/setup-python@v1
      with:
        python-version: pypy2
    - name: Install PyPy3
      uses: actions/setup-python@v1
      with:
        python-version: pypy3
      if: runner.os != 'Windows'  # see note 2 above.
    - name: Install Python 2.7
      uses: actions/setup-python@v1
      with:
        python-version: 2.7
    - name: Install Python 3.5
      uses: actions/setup-python@v1
      with:
        python-version: 3.5
    - name: Install Python 3.6
      uses: actions/setup-python@v1
      with:
        python-version: 3.6
    - name: Install Python 3.7
      uses: actions/setup-python@v1
      with:
        python-version: 3.7
    - name: Install Python 3.8
      uses: actions/setup-python@v1
      with:
        python-version: 3.8

    # Workaround https://github.com/theacodes/nox/issues/250
    - name: Workaround for Windows Python 2.7
      # This is in PATH, so nox resolves to it - but then subsequent steps fail.
      run: rm C:/ProgramData/Chocolatey/bin/python2.7.exe
      shell: bash
      if: runner.os == 'Windows'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install nox
      shell: bash

    - name: Run nox
      run: |
        python -m nox -s tests
      shell: bash
